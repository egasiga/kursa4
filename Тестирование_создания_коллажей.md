# Протокол тестирования функции создания коллажей

## Общее описание функции

Функция создания коллажей в приложении позволяет пользователям комбинировать несколько изображений в единую композицию с возможностью настройки макета, применения фильтров и добавления текста. Эта функция расширяет творческие возможности пользователей, давая им инструменты для создания сложных визуальных историй и многокадровых мемов.

## Техническое описание реализации

Функционал создания коллажей реализован следующим образом:

1. **Клиентский компонент** (`CollageLayoutSelector` в `client/src/components/collage-layout-selector.tsx`) предоставляет интерфейс для выбора макета и размещения изображений.

2. **Страница коллажей** (`CollageCreator` в `client/src/pages/collage-creator.tsx`) объединяет компоненты выбора макета, загрузки изображений и редактирования.

3. **Серверный API** включает эндпоинты для работы с коллажами:
   - `GET /api/collages` - получение списка сохраненных коллажей
   - `POST /api/collages` - создание нового коллажа
   - `PUT /api/collages/:id` - обновление существующего коллажа
   - `DELETE /api/collages/:id` - удаление коллажа

4. **Хранилище данных** содержит структуру `Collage` для хранения информации о коллажах, включая:
   - Массив источников изображений
   - Выбранный макет
   - Примененные фильтры
   - Добавленный текст

## Доступные макеты коллажей

В текущей версии приложения реализованы следующие макеты для коллажей:

1. **Сетка 2×2** - четыре ячейки одинакового размера, расположенные в виде квадратной сетки.

2. **Горизонтальные полосы** - три изображения, расположенные друг над другом.

3. **Вертикальные полосы** - три изображения, расположенные рядом друг с другом.

4. **Главное + 2 малых** - одно большое изображение и два маленьких рядом с ним.

5. **Инстаграм-карусель** - набор квадратных изображений с возможностью прокрутки.

## Детальный протокол тестирования

### Тест 1: Создание нового коллажа

**Цель**: Проверить процесс создания нового коллажа и выбора его макета.

**Порядок действий**:
1. Запустите приложение и перейдите в раздел "Коллажи" через навигационную панель
2. Нажмите кнопку "Создать новый коллаж"
3. В открывшемся интерфейсе выберите макет "Сетка 2×2" из доступных шаблонов
4. Проверьте, что на экране появился пустой макет с 4 ячейками для изображений
5. Убедитесь, что каждая ячейка содержит кнопку или область для добавления изображения

**Ожидаемый результат**:
- Интерфейс должен отобразить выбранный макет коллажа
- Все ячейки должны быть пустыми с возможностью добавления изображений
- Макет должен соответствовать выбранному типу (четыре равные ячейки в форме квадрата)

**Технический комментарий**:
При выборе макета функция `handleLayoutSelect(layout)` обновляет состояние `selectedLayout` в компоненте `CollageCreator`. Эта информация передается в компонент `CollageLayoutSelector`, который отрисовывает соответствующий макет с помощью CSS-сетки и позиционирования.

### Тест 2: Добавление изображений в коллаж

**Цель**: Проверить функциональность загрузки и размещения изображений в ячейках коллажа.

**Порядок действий**:
1. В созданном коллаже с макетом "Сетка 2×2" нажмите на первую пустую ячейку
2. В появившемся диалоге выберите опцию "Загрузить изображение"
3. Выберите файл изображения с вашего устройства (например, фотографию)
4. Повторите шаги 1-3 для второй ячейки, загрузив другое изображение
5. Для третьей ячейки используйте опцию "Выбрать из библиотеки", если она доступна
6. Оставьте четвертую ячейку пустой

**Ожидаемый результат**:
- Выбранные изображения должны быть загружены и корректно отображены в соответствующих ячейках
- Изображения должны автоматически масштабироваться, чтобы соответствовать размерам ячеек
- Заполненные ячейки должны показывать миниатюру загруженного изображения
- Незаполненная ячейка должна сохранить состояние "пусто" с возможностью добавления

**Технический комментарий**:
Процесс загрузки изображений использует компонент `Dropzone` для приема файлов. После загрузки функция `handleImageAdd(cellIndex, imageFile)` обновляет массив `sourceImages` в состоянии компонента. Библиотека `sharp` на сервере помогает обрабатывать изображения перед их сохранением.

### Тест 3: Применение фильтров к коллажу

**Цель**: Проверить возможность применения визуальных фильтров ко всем изображениям в коллаже.

**Порядок действий**:
1. В созданном коллаже с добавленными изображениями перейдите на вкладку "Фильтры" в панели инструментов
2. Установите ползунок "Яркость" на значение 115
3. Установите ползунок "Контрастность" на значение 125
4. Установите ползунок "Насыщенность" на значение 130
5. Наблюдайте за изменениями в коллаже в режиме реального времени
6. Нажмите кнопку "Сбросить фильтры"

**Ожидаемый результат**:
- При перемещении ползунков все изображения в коллаже должны изменяться в соответствии с выбранными значениями фильтров
- Яркость, контрастность и насыщенность должны применяться ко всем изображениям одновременно
- После нажатия кнопки "Сбросить фильтры" все изображения должны вернуться к своему исходному виду

**Технический комментарий**:
Функция `handleFilterChange(filterType, value)` обновляет объект `filters` в состоянии компонента. Эти значения передаются в функцию `applyFiltersToImage` через пропс `filters` компонента `CollageLayoutSelector`. Фильтры применяются к каждому изображению в коллаже с помощью CSS-фильтров или Canvas API.

### Тест 4: Добавление текста к коллажу

**Цель**: Проверить функцию добавления и форматирования текста в коллаже.

**Порядок действий**:
1. В коллаже перейдите на вкладку "Текст" в панели инструментов
2. Нажмите кнопку "Добавить текст"
3. В появившемся текстовом поле введите фразу "Мой первый коллаж"
4. Установите размер шрифта 28
5. Выберите цвет текста - белый
6. Включите опцию "Контур текста" и выберите черный цвет для контура
7. С помощью мыши перетащите текстовую область в центр коллажа

**Ожидаемый результат**:
- Текст должен появиться в коллаже и быть редактируемым
- Изменения стиля текста (размер, цвет, контур) должны отображаться в режиме реального времени
- Должна быть возможность свободно позиционировать текст в любом месте коллажа
- Текст должен корректно отображаться поверх изображений

**Технический комментарий**:
Компонент `TextEditor` используется для управления текстовым содержимым. Функция `handleTextAdd()` добавляет новый текстовый элемент в массив `textContent`. Позиционирование реализовано с помощью CSS `position: absolute` и обновляется через функцию `handleTextPositionChange(textId, x, y)` при перетаскивании.

### Тест 5: Изменение порядка изображений в коллаже

**Цель**: Проверить возможность изменения порядка и перестановки изображений в коллаже.

**Порядок действий**:
1. В коллаже с добавленными изображениями (минимум в двух ячейках) найдите кнопку "Поменять местами" или аналогичный элемент управления
2. Выберите изображение в первой ячейке
3. Выберите изображение в другой ячейке для обмена
4. Подтвердите операцию обмена
5. Попробуйте аналогичную операцию с другой парой изображений

**Ожидаемый результат**:
- Выбранные изображения должны поменяться местами в макете коллажа
- Размеры и пропорции изображений должны автоматически адаптироваться к новым ячейкам
- Все примененные эффекты и фильтры должны сохраняться при перестановке

**Технический комментарий**:
Функция `handleImageSwap(sourceIndex, targetIndex)` меняет местами элементы в массиве `sourceImages`, что приводит к перерисовке компонента с обновленным порядком изображений. Используется неизменяемый подход с созданием нового массива для обеспечения правильной реакции React на изменения.

### Тест 6: Сохранение и экспорт коллажа

**Цель**: Проверить функции сохранения коллажа в коллекции пользователя и экспорта в виде изображения.

**Порядок действий**:
1. После создания и настройки коллажа (добавление изображений, текста, применение фильтров)
2. В поле "Название коллажа" введите "Тестовый коллаж"
3. Нажмите кнопку "Сохранить коллаж"
4. Проверьте уведомление об успешном сохранении
5. Теперь нажмите кнопку "Скачать как изображение"
6. Проверьте папку загрузок вашего браузера
7. Перейдите в раздел "Мои коллажи" и убедитесь, что ваш коллаж там появился

**Ожидаемый результат**:
- Коллаж должен быть успешно сохранен в базе данных приложения
- При скачивании должен создаваться файл изображения (PNG или JPEG) с готовым коллажем
- В разделе "Мои коллажи" должна отображаться миниатюра созданного коллажа
- Должна быть возможность открыть ранее сохраненный коллаж для редактирования

**Технический комментарий**:
Функция `handleSaveCollage()` собирает все данные коллажа (источники изображений, макет, фильтры, текст) и отправляет их на сервер через POST-запрос к `/api/collages`. Для экспорта коллажа как изображения используется Canvas API, которое преобразует DOM-элементы коллажа в растровое изображение с помощью `html2canvas` или аналогичной библиотеки.

### Тест 7: Удаление изображений из коллажа

**Цель**: Проверить возможность удаления отдельных изображений из ячеек коллажа.

**Порядок действий**:
1. В коллаже с добавленными изображениями наведите курсор на изображение в одной из ячеек
2. Обратите внимание на появление кнопки или иконки "Удалить" (обычно в виде крестика или корзины)
3. Нажмите на эту кнопку для выбранного изображения
4. Подтвердите операцию удаления в диалоговом окне, если оно появляется
5. Проверьте состояние ячейки после удаления

**Ожидаемый результат**:
- После удаления ячейка должна вернуться в пустое состояние
- Должна появиться возможность добавить новое изображение в эту ячейку
- Остальные изображения и их расположение не должны измениться
- Общий макет коллажа должен сохраниться без изменений

**Технический комментарий**:
Функция `handleRemoveImage(index)` используется для удаления изображения из массива `sourceImages`. Она устанавливает значение `null` для соответствующего индекса, что приводит к отображению пустой ячейки с возможностью добавления нового изображения.

## Выводы по результатам тестирования

Функция создания коллажей демонстрирует высокую степень гибкости и интуитивности использования. Пользователи могут легко создавать разнообразные композиции из нескольких изображений, добавлять текст и применять визуальные эффекты к результату.

Особенно удобным является то, что все изменения отображаются в режиме реального времени, позволяя сразу видеть результат каждого действия. Интеграция с системой хранения позволяет сохранять коллажи для последующего редактирования, а функция экспорта обеспечивает возможность использования созданных коллажей за пределами приложения.

Потенциальным направлением развития функционала коллажей может быть добавление новых типов макетов, возможность редактирования границ между изображениями и внедрение более продвинутых инструментов для слияния изображений с различными режимами наложения.